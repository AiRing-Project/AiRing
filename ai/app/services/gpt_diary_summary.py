import json

from openai import OpenAI

from core.config import get_settings

settings = get_settings()
client = OpenAI(api_key=settings.OPENAI_API_KEY)


def generate_diary_from_dialogue(raw_script: str) -> dict:
    dialogue_text = raw_script.strip()

    prompt = f"""
너는 사용자와 AI가 나눈 대화를 바탕으로, '일기 제목'과 '일기 내용'을 작성하는 작가야.

아래는 하루 동안 사용자와 AI가 나눈 실제 대화야. 이 대화의 흐름, 분위기를 전체적으로 고려해서 하루 일기를 작성해줘.

- AI의 질문이나 반응도 대화의 맥락으로 간접 반영해.
- 일기체 문장으로, 마치 사용자가 직접 쓴 것처럼 작성해줘.
- 너무 과격한 표현(예: '개피곤했다')은 감정은 유지하되 부드럽게 바꿔줘.
- 문장 어순이 매끄럽고 감정 흐름이 자연스럽게 이어지도록 구성해줘.
- 감정을 과장하거나 없는 감정을 상상하지 마.
- AI와의 대화임을 명확히 반영하고, 제3자의 존재를 가정하지 마세요.
- 사용자 발화량이 적으면, 일기도 짧고 간결하게 작성해줘.
- 사용자가 단답형으로 감정을 표현했다면, 그 분위기를 그대로 반영해줘.
- 사용자의 말투와 텐션을 유지해서 글이 너무 미화되거나 길어지지 않도록 해줘.
- 오늘의 대화가 짧거나 무뚝뚝했다면, 일기도 딱 그 정도의 톤과 길이로 마무리해.
- 문장 수나 문단 수를 정하지 말고, 대화 길이에 따라 자연스럽게 정해줘.
- 감정을 분석하거나 설명하지 마. 그저 표현된 대로만 받아들여.
- '고마워'라고 했더라도 그 감정의 깊이를 해석하지 마.
- 최대한 감정 묘사와 해석을 배제하고, 말투 그대로만 반영해.
- AI와의 대화 덕분에 무언가 정리되었다는 식의 문장은 사용자가 실제 말한 내용이 아닌 이상 절대 넣지 마.
- '오늘이 정리되는 느낌이었다', '덕분에 위로가 됐다' 등은 사용자가 직접 표현하지 않았다면 포함하지 마.
- AI임을 드러내지 말고, 굳이 사용할거면 '전화 일기'라 표현을 대체해줘
- 문법이 어색한 표현은, 맥락에 따라 자연스럽게 풀어줘.
- 문단은 지나치게 나누지 말고, 대화 흐름이 이어지는 대로 자연스럽게 묶어줘.
- 글이 끊기거나 인위적으로 정리된 느낌이 들지 않게 해줘.
- 문장은 가능하면 종결어미를 '~다' 형태로 마무리해줘.
- 같은 표현을 여러 번 바꾸어 말하지 마.

반드시 아래 형식으로 JSON만 출력해줘:

{{
  "title": "...",
  "content": "..."
}}

대화 내용:
\"\"\"{dialogue_text}\"\"\"
"""

    response = client.chat.completions.create(
        model="gpt-4",
        messages=[{"role": "user", "content": prompt}],
        temperature=0.7,
    )

    return json.loads(response.choices[0].message.content)
